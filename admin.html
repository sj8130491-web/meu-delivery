<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin | Marmita do Chefe</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">Painel Administrativo</h1>

        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="font-bold mb-4 italic uppercase text-red-600">Cadastrar Novo Produto</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="add-nome" placeholder="Nome do Produto" class="border p-2 rounded">
                <input type="number" id="add-preco" placeholder="Preço (Ex: 25.00)" class="border p-2 rounded">
                <select id="add-categoria" class="border p-2 rounded">
                    <option value="marmitas">Marmita</option>
                    <option value="espetinhos">Espetinho</option>
                    <option value="bebidas">Bebida</option>
                </select>
                <input type="text" id="add-img" placeholder="Link da Imagem" class="border p-2 rounded">
                <textarea id="add-ingredientes" placeholder="Lista de Ingredientes" class="border p-2 rounded md:col-span-2"></textarea>
                <button onclick="salvarProduto()" class="bg-green-600 text-white p-3 rounded font-bold md:col-span-2">SALVAR PRODUTO</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="font-bold mb-4 italic uppercase text-gray-700">Produtos Ativos</h2>
            <div id="tabela-admin" class="space-y-4">
                </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const _supabase = supabase.createClient('SUA_URL', 'SUA_KEY');

        async function salvarProduto() {
            const p = {
                nome: document.getElementById('add-nome').value,
                preco: parseFloat(document.getElementById('add-preco').value),
                categoria: document.getElementById('add-categoria').value,
                imagem: document.getElementById('add-img').value,
                descricao: document.getElementById('add-desc').value,
                ingredientes: document.getElementById('add-ingredientes').value
            };

            const { error } = await _supabase.from('produto').insert([p]);
            if (error) alert("Erro ao salvar!");
            else { alert("Sucesso!"); location.reload(); }
        }

        async function carregarAdmin() {
            const { data } = await _supabase.from('produto').select('*');
            document.getElementById('tabela-admin').innerHTML = data.map(p => `
                <div class="flex justify-between items-center border-b pb-2">
                    <div>
                        <p class="font-bold">${p.nome} - R$ ${p.preco}</p>
                        <p class="text-xs text-gray-500">${p.categoria}</p>
                    </div>
                    <button onclick="deletar(${p.id})" class="text-red-500 font-bold">Excluir</button>
                </div>
            `).join('');
        }
        carregarAdmin();
    </script>
</body><div class="bg-white p-6 rounded-xl shadow-md mt-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="font-bold italic uppercase text-gray-700">Histórico de Pedidos (Hoje)</h2>
        <button onclick="carregarRelatorio()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase">Atualizar Lista</button>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead>
                <tr class="border-b text-gray-400 uppercase text-[10px]">
                    <th class="py-3">Hora</th>
                    <th>Cliente</th>
                    <th>Itens</th>
                    <th>Total</th>
                    <th class="text-right">Ação</th>
                </tr>
            </thead>
            <tbody id="tabela-pedidos">
                </tbody>
        </table>
    </div>
</div>

<div id="comanda-print" class="hidden">
    <style>
        @media print {
            body * { visibility: hidden; }
            #comanda-print, #comanda-print * { visibility: visible; }
            #comanda-print { position: absolute; left: 0; top: 0; width: 80mm; font-family: monospace; padding: 10px; }
            .line { border-bottom: 1px dashed #000; margin: 5px 0; }
            .text-center { text-align: center; }
            .bold { font-weight: bold; }
        }
    </style>
    <div class="text-center">
        <h2 class="bold">ESPETINHO DO CHEFE</h2>
        <p>Comanda de Pedido</p>
    </div>
    <div class="line"></div>
    <div id="comanda-dados"></div>
    <div class="line"></div>
    <p class="text-center bold">Obrigado pela preferência!</p>
</div>

<script>
    // Função para buscar pedidos do dia
    async function carregarRelatorio() {
        const hoje = new Date().toISOString().split('T')[0];
        const { data, error } = await _supabase
            .from('pedidos')
            .select('*')
            .gte('created_at', hoje)
            .order('created_at', { ascending: false });

        if (data) {
            const html = data.map(p => {
                const hora = new Date(p.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-4 font-bold">${hora}</td>
                    <td>${p.cliente}</td>
                    <td class="text-xs text-gray-500 truncate max-w-[200px]">${p.itens}</td>
                    <td class="font-bold text-green-600">R$ ${p.total.toFixed(2)}</td>
                    <td class="text-right">
                        <button onclick="imprimirComanda('${p.id}')" class="bg-gray-800 text-white px-3 py-1 rounded text-[10px] font-bold">IMPRIMIR</button>
                    </td>
                </tr>`;
            }).join('');
            document.getElementById('tabela-pedidos').innerHTML = html;
            
            // Atualiza os contadores de faturamento
            const totalSoma = data.reduce((acc, p) => acc + p.total, 0);
            document.getElementById('total-vendas-dia').innerText = `R$ ${totalSoma.toFixed(2)}`;
            document.getElementById('qtd-pedidos-dia').innerText = data.length;
        }
    }

    // Função para formatar e abrir a impressão
    async function imprimirComanda(id) {
        const { data } = await _supabase.from('pedidos').select('*').eq('id', id).single();
        
        if (data) {
            const hora = new Date(data.created_at).toLocaleTimeString();
            const htmlComanda = `
                <p><b>DATA:</b> ${new Date(data.created_at).toLocaleDateString()} ${hora}</p>
                <p><b>CLIENTE:</b> ${data.cliente}</p>
                <p><b>FORMA PAGTO:</b> ${data.pagamento}</p>
                <div class="line"></div>
                <p class="bold text-center">ITENS DO PEDIDO</p>
                <p style="white-space: pre-wrap;">${data.itens.replace(/,/g, '\n')}</p>
                <div class="line"></div>
                <p class="bold" style="font-size: 1.2rem">TOTAL: R$ ${data.total.toFixed(2)}</p>
            `;
            document.getElementById('comanda-dados').innerHTML = htmlComanda;
            window.print();
        }
    }

    // Inicializa a lista
    carregarRelatorio();
</script>
</html>