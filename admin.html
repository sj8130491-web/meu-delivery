<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Delivery - Gest√£o de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; }
        .card-pedido { background: #1e293b; border: 1px solid #334155; }
    </style>
</head>
<body class="p-4">

    <div class="max-w-xl mx-auto space-y-6">
        <div class="flex justify-between items-center bg-slate-900 p-5 rounded-3xl border border-slate-800">
            <div>
                <h1 class="text-lg font-black text-red-500 uppercase">Admin <span class="text-white">Delivery</span></h1>
                <input type="date" id="data_filtro" onchange="carregarVendas()" class="bg-transparent text-xs font-bold text-slate-400 outline-none">
            </div>
            <div class="text-right">
                <p class="text-[10px] font-bold text-slate-500 uppercase">Total Hoje</p>
                <h2 id="faturamento_total" class="text-xl font-black text-green-500">R$ 0,00</h2>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="baixarRelatorio()" class="bg-slate-800 hover:bg-slate-700 text-white text-[10px] font-bold py-3 rounded-xl uppercase border border-slate-700">
                üì• Baixar PDF
            </button>
            <button onclick="limparVendasDoDia()" class="bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white text-[10px] font-bold py-3 rounded-xl uppercase border border-red-600/40">
                üóëÔ∏è Zerar Dia
            </button>
        </div>

        <div id="container_pedidos" class="space-y-3">
            </div>
    </div>

    <script>
        const SB_URL = 'https://sehjsvlsmawphpjjekwl.supabase.co';
        const SB_KEY = 'sb_publishable_JJ7LlwBIWko8VXWPLHb0RA_4AmFMuYK';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // Define a data de hoje ao abrir
        document.getElementById('data_filtro').valueAsDate = new Date();

        async function carregarVendas() {
            const dataBusca = document.getElementById('data_filtro').value;
            const lista = document.getElementById('container_pedidos');
            
            // BUSCA NA TABELA DE PEDIDOS (Ajuste o nome 'pedidos' se for outro no seu Supabase)
            const { data, error } = await _supabase
                .from('pedidos') 
                .select('*')
                .eq('data', dataBusca);

            if (error) return console.log("Erro ao buscar:", error);

            let totalDinheiro = 0;
            lista.innerHTML = "";

            if (data.length === 0) {
                lista.innerHTML = `<p class="text-center text-slate-500 py-10 italic text-sm">Nenhum pedido hoje.</p>`;
                document.getElementById('faturamento_total').innerText = "R$ 0,00";
                return;
            }

            data.forEach(p => {
                const valor = Number(p.total || p.valor || 0);
                totalDinheiro += valor;

                lista.innerHTML += `
                    <div class="card-pedido p-4 rounded-2xl flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-sm">${p.cliente}</h3>
                            <p class="text-[10px] text-slate-400">${p.itens || 'Pedido'}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-green-500 font-bold text-sm">R$ ${valor.toFixed(2)}</span>
                            <br>
                            <button onclick="deletarUm(${p.id})" class="text-[9px] text-slate-600 uppercase">Remover</button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('faturamento_total').innerText = `R$ ${totalDinheiro.toFixed(2)}`;
        }

        function baixarRelatorio() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dataS = document.getElementById('data_filtro').value;
            const totalS = document.getElementById('faturamento_total').innerText;

            doc.text(`RELAT√ìRIO DELIVERY - DATA: ${dataS}`, 10, 10);
            doc.text(`FATURAMENTO: ${totalS}`, 10, 20);
            doc.text("---------------------------------------", 10, 30);

            let y = 40;
            document.querySelectorAll('.card-pedido').forEach(c => {
                doc.text(c.innerText.replace(/\s+/g, ' '), 10, y);
                y += 10;
            });

            doc.save(`vendas_${dataS}.pdf`);
        }

        async function limparVendasDoDia() {
            const dataS = document.getElementById('data_filtro').value;
            if (confirm("Deseja apagar todos os pedidos de hoje?")) {
                await _supabase.from('pedidos').delete().eq('data', dataS);
                carregarVendas();
            }
        }

        async function deletarUm(id) {
            await _supabase.from('pedidos').delete().eq('id', id);
            carregarVendas();
        }

        carregarVendas();
    </script>
</body>
</html>